<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Portal do Navegador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-8 text-center text-teal-700">
            Portal do Navegador - Teste Final
        </h1>
        
        <!-- Status -->
        <div id="status" class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Status do Sistema</h2>
            <div id="status-messages"></div>
        </div>
        
        <!-- Botões de Teste -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Testes Diretos</h2>
            <div class="grid grid-cols-3 gap-4">
                <button onclick="testOpenPatient('PAC-001')" class="bg-blue-600 text-white p-4 rounded hover:bg-blue-700">
                    <i class="fas fa-user mb-2"></i><br>
                    Abrir Maria Silva
                </button>
                <button onclick="testOpenPatient('PAC-002')" class="bg-green-600 text-white p-4 rounded hover:bg-green-700">
                    <i class="fas fa-user mb-2"></i><br>
                    Abrir Ana Costa
                </button>
                <button onclick="testOpenPatient('PAC-003')" class="bg-purple-600 text-white p-4 rounded hover:bg-purple-700">
                    <i class="fas fa-user mb-2"></i><br>
                    Abrir Carlos Mendes
                </button>
            </div>
        </div>
        
        <!-- Portal Container -->
        <div id="portal-container" class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Portal do Navegador</h2>
            <div id="portal-content">Carregando...</div>
        </div>
    </div>
    
    <script>
        // Sistema de log
        function addStatus(message, type = 'info') {
            const div = document.getElementById('status-messages');
            const p = document.createElement('p');
            p.className = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
            p.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            div.appendChild(p);
            console.log(message);
        }
        
        // Definir função global openPatientView
        window.openPatientView = function(patientId) {
            addStatus(`Abrindo view do paciente ${patientId}`, 'success');
            
            // Criar modal
            let modal = document.getElementById('patient-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'patient-modal';
                modal.className = 'fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4';
                modal.style.display = 'none';
                document.body.appendChild(modal);
            }
            
            // Dados do paciente
            const patients = {
                'PAC-001': { nome: 'Maria Silva', diagnostico: 'CA Mama', idade: 52 },
                'PAC-002': { nome: 'Ana Costa', diagnostico: 'CA Pulmão', idade: 45 },
                'PAC-003': { nome: 'Carlos Mendes', diagnostico: 'CA Colorretal', idade: 67 }
            };
            
            const patient = patients[patientId] || patients['PAC-001'];
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-auto">
                    <div class="bg-teal-600 text-white p-6">
                        <div class="flex justify-between">
                            <h2 class="text-2xl font-bold">${patient.nome}</h2>
                            <button onclick="closePatientModal()" class="text-white hover:text-gray-200">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded">
                                <h3 class="font-bold mb-2">Dados Clínicos</h3>
                                <p>Diagnóstico: ${patient.diagnostico}</p>
                                <p>Idade: ${patient.idade} anos</p>
                                <p>ID: ${patientId}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded">
                                <h3 class="font-bold mb-2">Status</h3>
                                <p>Em tratamento</p>
                                <p>Ciclo 3 de 6</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button onclick="closePatientModal()" class="bg-teal-600 text-white px-6 py-2 rounded hover:bg-teal-700">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // Fechar modal
        window.closePatientModal = function() {
            const modal = document.getElementById('patient-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Teste direto
        window.testOpenPatient = function(patientId) {
            addStatus(`Teste direto: Abrindo ${patientId}`);
            window.openPatientView(patientId);
        }
        
        // Carregar portal
        async function loadPortal() {
            addStatus('Iniciando carregamento do portal...');
            
            try {
                const response = await fetch('/api/portal/navigator');
                const data = await response.json();
                
                addStatus('Portal carregado com sucesso', 'success');
                
                // Renderizar HTML
                document.getElementById('portal-content').innerHTML = data.html;
                
                // Executar scripts
                if (data.scripts && data.scripts.length > 0) {
                    addStatus(`Executando ${data.scripts.length} scripts...`);
                    data.scripts.forEach((script, index) => {
                        try {
                            eval(script);
                            addStatus(`Script ${index + 1} executado`, 'success');
                        } catch (e) {
                            addStatus(`Erro no script ${index + 1}: ${e.message}`, 'error');
                        }
                    });
                }
                
                // Verificar se a função foi criada
                if (typeof window.openPatientView === 'function') {
                    addStatus('Função openPatientView disponível!', 'success');
                } else {
                    addStatus('Função openPatientView NÃO encontrada', 'error');
                }
                
                // Configurar eventos nos cards
                setTimeout(() => {
                    const cards = document.querySelectorAll('.kanban-card');
                    addStatus(`Encontrados ${cards.length} cards`);
                    
                    cards.forEach((card, index) => {
                        card.style.cursor = 'pointer';
                        card.onclick = function(e) {
                            e.preventDefault();
                            const patientId = this.dataset.patientId || `PAC-00${index + 1}`;
                            addStatus(`Card clicado: ${patientId}`);
                            window.openPatientView(patientId);
                        };
                    });
                }, 1000);
                
            } catch (error) {
                addStatus(`Erro: ${error.message}`, 'error');
            }
        }
        
        // Iniciar ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            addStatus('Página carregada');
            loadPortal();
        });
    </script>
</body>
</html>